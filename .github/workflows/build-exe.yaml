on:
  push:
    branches: ["testing"]

jobs:
  build-exe:
    runs-on: windows-latest
    steps:
      # System depedencies
      - uses: ilammy/msvc-dev-cmd@v1
      - uses: luarocks/gh-actions-lua@master  # See https://github.com/lunarmodules/luasystem/pull/17#issuecomment-1986387525
        with:
          luaVersion: "5.1"
      - uses: luarocks/gh-actions-luarocks@master  # See https://github.com/leafo/gh-actions-luarocks/pull/14
        with:
          luaRocksVersion: "3.11.1"

      - run: tree ".lua" /f /a
      - run: type $env:APPDATA"/luarocks/config-5.1.lua"

      - name: Checkout custom luapak
        uses: actions/checkout@v4
        with:
          repository: RiskoZoSlovenska/luapak
          ref: windows
          path: luapak

      - name: Install custom luapak
        run: luarocks make
        working-directory: luapak

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: pilot-compiler

      - name: Bundle
        run: |
          luapak make --verbose `
            --lua="${{ github.workspace }}/.lua/bin/lua.exe" `
            --lua-incdir="${{ github.workspace }}/.lua/include" `
            --lua-lib="${{ github.workspace }}/.lua/lib/lua51.lib"
          tree /f /a
        working-directory: pilot-compiler

      - uses: actions/upload-artifact@v4
        with:
          path: pilot-compiler/dist/pilot-compiler.exe

      - name: Test
        run: ../dist/pilot-compiler.exe main.lua
        working-directory: pilot-compiler/example
